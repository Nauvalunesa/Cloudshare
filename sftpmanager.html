<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced SFTP Manager - CloudShare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00acc1;
            --primary-dark: #00838f;
            --bg-dark: #1e1e1e;
            --bg-darker: #141414;
            --bg-panel: #252525;
            --border: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --hover: #333;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --local-accent: #9c27b0;
            --remote-accent: #00acc1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-darker);
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .logo i {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--local-accent), var(--remote-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator.disconnected {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }

        .status-indicator.connected {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        /* Main Container */
        .container {
            display: flex;
            height: calc(100vh - 72px);
        }

        /* Panel */
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            position: relative;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel-header {
            padding: 1rem 1.5rem;
            background: var(--bg-darker);
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-header.local {
            border-bottom-color: var(--local-accent);
        }

        .panel-header.remote {
            border-bottom-color: var(--remote-accent);
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .panel-title.local {
            color: var(--local-accent);
        }

        .panel-title.remote {
            color: var(--remote-accent);
        }

        .panel-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--hover);
            color: var(--text-primary);
            border-color: var(--primary);
        }

        /* Path Bar */
        .path-bar {
            padding: 0.8rem 1.5rem;
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .path-bar input {
            flex: 1;
            padding: 0.5rem 0.8rem;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .path-bar input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* File List */
        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .file-item {
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            border: 2px solid transparent;
        }

        .file-item:hover {
            background: var(--hover);
        }

        .file-item.selected {
            background: rgba(0, 172, 193, 0.2);
            border-color: var(--primary);
        }

        .file-item.dragging {
            opacity: 0.5;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .file-icon.folder {
            color: #ffa726;
        }

        /* File type specific colors */
        .file-icon.js { color: #f7df1e; }
        .file-icon.json { color: #f7df1e; }
        .file-icon.py { color: #3776ab; }
        .file-icon.html { color: #e34c26; }
        .file-icon.css { color: #264de4; }
        .file-icon.php { color: #8892be; }
        .file-icon.md { color: #083fa1; }
        .file-icon.txt { color: var(--text-secondary); }
        .file-icon.sh { color: #89e051; }
        .file-icon.yml, .file-icon.yaml { color: #cb171e; }
        .file-icon.xml { color: #e37933; }
        .file-icon.sql { color: #00758f; }
        .file-icon.go { color: #00add8; }
        .file-icon.rs { color: #dea584; }
        .file-icon.java { color: #f89820; }
        .file-icon.cpp, .file-icon.c { color: #00599c; }
        .file-icon.rb { color: #cc342d; }
        .file-icon.vue { color: #42b883; }
        .file-icon.ts { color: #3178c6; }
        .file-icon.jsx, .file-icon.tsx { color: #61dafb; }
        .file-icon.file { color: var(--text-secondary); }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
            display: flex;
            gap: 1rem;
        }

        .file-actions {
            display: flex;
            gap: 0.3rem;
            opacity: 1; /* Always visible now */
            transition: opacity 0.2s;
        }

        .file-actions button {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-darker);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .file-actions button:hover {
            background: var(--primary);
            color: white;
        }

        /* Drag & Drop Overlay */
        .drop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 172, 193, 0.1);
            border: 3px dashed var(--primary);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            z-index: 100;
        }

        .drop-overlay.active {
            display: flex;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            padding: 0.5rem;
            display: none;
            z-index: 1000;
            min-width: 200px;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 0.7rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .context-menu-item:hover {
            background: var(--hover);
        }

        .context-menu-item.danger {
            color: var(--danger);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 0.5rem 0;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 2rem;
            min-width: 400px;
            max-width: 90vw;
            max-height: 90vh;
            border: 1px solid var(--border);
            overflow: auto;
        }

        /* Editor Modal - Larger */
        .modal-content.editor-modal {
            min-width: 95vw;
            min-height: 90vh;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .editor-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-darker);
        }

        .editor-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .editor-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        #editor-container {
            flex: 1;
            min-height: 500px;
            border-bottom: 1px solid var(--border);
        }

        .editor-footer {
            padding: 1rem 2rem;
            background: var(--bg-darker);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-stats {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            gap: 1.5rem;
        }

        .close-editor {
            position: absolute;
            top: 1.5rem;
            right: 2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.2s;
            z-index: 10;
        }

        .close-editor:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-actions {
            display: flex;
            gap: 0.8rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn-secondary {
            background: var(--bg-darker);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--hover);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            padding: 2rem;
            text-align: center;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            margin-bottom: 1rem;
        }

        .empty-state .quick-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Local Drop Zone - Always Visible */
        .local-drop-zone {
            position: absolute;
            top: 120px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            border: 3px dashed var(--local-accent);
            border-radius: 12px;
            background: rgba(156, 39, 176, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--local-accent);
            font-size: 1.2rem;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            z-index: 1;
        }

        .local-drop-zone:hover {
            background: rgba(156, 39, 176, 0.1);
            border-color: var(--local-accent);
            transform: scale(1.02);
        }

        .local-drop-zone.active {
            background: rgba(156, 39, 176, 0.2);
            border-color: var(--local-accent);
            border-width: 4px;
        }

        .local-drop-zone i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .local-drop-zone .drop-text {
            margin-bottom: 0.5rem;
        }

        .local-drop-zone .drop-hint {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .file-list.has-files {
            z-index: 2;
            position: relative;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-darker);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--hover);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            /* Stack panels vertically on mobile */
            .container {
                flex-direction: column;
                height: auto;
                min-height: calc(100vh - 72px);
            }

            .panel {
                min-height: 50vh;
                border-right: none;
                border-bottom: 2px solid var(--border);
            }

            .panel:last-child {
                border-bottom: none;
            }

            /* Adjust header for mobile */
            .header {
                padding: 0.8rem 1rem;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            /* Panel headers */
            .panel-header {
                padding: 0.8rem 1rem;
            }

            .panel-title {
                font-size: 1rem;
            }

            /* Connection form adjustments */
            .connection-form {
                padding: 1rem;
            }

            .form-row {
                flex-direction: column;
            }

            .form-group {
                width: 100%;
            }

            /* File items - make touch friendly */
            .file-item {
                padding: 0.8rem;
                min-height: 60px;
            }

            .file-name {
                font-size: 0.9rem;
            }

            .file-meta {
                font-size: 0.75rem;
            }

            /* Larger touch targets for buttons */
            .file-actions button {
                width: 40px;
                height: 40px;
            }

            .icon-btn {
                width: 40px;
                height: 40px;
            }

            /* Button adjustments */
            button, .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            /* Editor modal - full screen on mobile */
            .modal-content.editor-modal {
                min-width: 100vw;
                min-height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
            }

            .editor-header {
                padding: 1rem;
            }

            .editor-title {
                font-size: 0.9rem;
            }

            .editor-info {
                font-size: 0.75rem;
            }

            .editor-footer {
                padding: 0.8rem 1rem;
            }

            .editor-stats {
                font-size: 0.75rem;
                gap: 0.8rem;
            }

            /* Context menu */
            .context-menu {
                min-width: 180px;
            }

            /* Drop zone */
            .local-drop-zone {
                padding: 2rem 1rem;
            }

            .local-drop-zone i {
                font-size: 2.5rem;
            }

            .drop-text {
                font-size: 1rem;
            }

            /* Breadcrumb */
            .breadcrumb {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            /* Hide some less critical info on very small screens */
            @media (max-width: 480px) {
                .file-meta span:not(:first-child) {
                    display: none;
                }

                .editor-info {
                    display: none;
                }

                .panel-actions .icon-btn:not(:first-child) {
                    display: none;
                }
            }
        }

        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .panel {
                min-width: 400px;
            }

            .modal-content.editor-modal {
                min-width: 90vw;
                min-height: 85vh;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-exchange-alt"></i>
            <span>Advanced SFTP Manager</span>
        </div>
        <div class="connection-status">
            <div class="status-indicator disconnected" id="connection-status">
                <i class="fas fa-circle"></i>
                <span>Disconnected</span>
            </div>
            <button class="btn btn-primary" onclick="showConnectModal()" id="connect-btn">
                <i class="fas fa-plug"></i>
                Connect to SFTP
            </button>
            <button class="btn btn-danger" onclick="disconnect()" id="disconnect-btn" style="display: none;">
                <i class="fas fa-times"></i>
                Disconnect
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Local Panel -->
        <div class="panel" id="local-panel">
            <div class="panel-header local">
                <div class="panel-title local">
                    <i class="fas fa-laptop"></i>
                    <span>Local Device</span>
                </div>
                <div class="panel-actions">
                    <button class="icon-btn" onclick="selectLocalFiles()" title="Select Files">
                        <i class="fas fa-file-import"></i>
                    </button>
                    <button class="icon-btn" onclick="selectLocalFolder()" title="Select Folder">
                        <i class="fas fa-folder-open"></i>
                    </button>
                    <button class="icon-btn" onclick="refreshLocal()" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="path-bar">
                <i class="fas fa-folder"></i>
                <span id="local-path">Drag files here or click to browse</span>
            </div>
            <div class="file-list" id="local-list"></div>
            <div class="local-drop-zone" id="local-drop-zone" onclick="selectLocalFolder()">
                <i class="fas fa-cloud-upload-alt"></i>
                <div class="drop-text">üìÅ Drag & Drop Files Here</div>
                <div class="drop-hint">or click anywhere to browse your device</div>
                <div class="quick-actions" style="margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); selectLocalFiles()">
                        <i class="fas fa-file"></i> Select Files
                    </button>
                    <button class="btn btn-primary" onclick="event.stopPropagation(); selectLocalFolder()">
                        <i class="fas fa-folder"></i> Select Folder
                    </button>
                </div>
            </div>
            <div class="drop-overlay" id="local-drop">
                <div>
                    <i class="fas fa-download"></i>
                    <div>Drop files here to download from SFTP</div>
                </div>
            </div>
        </div>

        <!-- Remote Panel -->
        <div class="panel" id="remote-panel">
            <div class="panel-header remote">
                <div class="panel-title remote">
                    <i class="fas fa-server"></i>
                    <span>Remote SFTP Server</span>
                </div>
                <div class="panel-actions">
                    <button class="icon-btn" onclick="createRemoteFile()" title="New File" disabled id="new-file-btn">
                        <i class="fas fa-file-plus"></i>
                    </button>
                    <button class="icon-btn" onclick="createRemoteFolder()" title="New Folder" disabled id="new-folder-btn">
                        <i class="fas fa-folder-plus"></i>
                    </button>
                    <button class="icon-btn" onclick="refreshRemote()" title="Refresh" disabled id="refresh-btn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="path-bar">
                <i class="fas fa-folder"></i>
                <input type="text" id="remote-path" placeholder="/" disabled>
                <button class="icon-btn" onclick="goToPath()" title="Go" disabled id="go-btn">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            <div class="file-list" id="remote-list">
                <div class="empty-state">
                    <i class="fas fa-plug"></i>
                    <h3>Not Connected</h3>
                    <p>Connect to an SFTP server to browse remote files</p>
                </div>
            </div>
            <div class="drop-overlay" id="remote-drop">
                <div>
                    <i class="fas fa-upload"></i>
                    <div>Drop files here to upload to SFTP</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connect Modal -->
    <div class="modal" id="connect-modal">
        <div class="modal-content">
            <h2 class="modal-title">Connect to SFTP Server</h2>
            <form id="connect-form" onsubmit="connectToSFTP(event)">
                <div class="form-group">
                    <label>Host</label>
                    <input type="text" id="sftp-host" required placeholder="example.com">
                </div>
                <div class="form-group">
                    <label>Port</label>
                    <input type="number" id="sftp-port" value="22" required>
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="sftp-username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="sftp-password" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeConnectModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plug"></i>
                        Connect
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- File Editor Modal -->
    <div class="modal" id="editor-modal">
        <div class="modal-content editor-modal">
            <button class="close-editor" onclick="closeEditor()">&times;</button>
            <div class="editor-header">
                <div class="editor-title">
                    <i class="fas fa-file-code"></i>
                    <span id="editor-filename">Untitled</span>
                </div>
                <div class="editor-info">
                    <span><i class="fas fa-code"></i> <span id="editor-language">plaintext</span></span>
                    <span><i class="fas fa-hdd"></i> <span id="editor-size">0 B</span></span>
                    <span id="editor-modified" style="display: none; color: var(--warning);">
                        <i class="fas fa-circle"></i> Modified
                    </span>
                </div>
            </div>
            <div id="editor-container"></div>
            <div class="editor-footer">
                <div class="editor-stats">
                    <span><i class="fas fa-stream"></i> Lines: <strong id="editor-lines">0</strong></span>
                    <span><i class="fas fa-text-width"></i> Chars: <strong id="editor-chars">0</strong></span>
                    <span><i class="fas fa-map-marker-alt"></i> Ln <strong id="editor-ln">1</strong>, Col <strong id="editor-col">1</strong></span>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditor()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveFile()" id="save-btn">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <!-- Will be populated dynamically -->
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="file-input" multiple hidden>
    <input type="file" id="folder-input" webkitdirectory directory hidden>

    <script>
        // Global state
        let localFiles = [];
        let remoteFiles = [];
        let currentRemotePath = '/';
        let selectedLocal = new Set();
        let selectedRemote = new Set();
        let isConnected = false;
        let localDirectoryHandle = null;
        let contextMenuTarget = null;
        let contextMenuSide = null;

        // Monaco Editor
        let monacoEditor = null;
        let currentEditingFile = null;
        let editorOriginalContent = '';

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            setupLocalDropZone();
            tryRestoreLastFolder();
            initMonacoEditor();
        });

        function initMonacoEditor() {
            require(['vs/editor/editor.main'], function () {
                console.log('Monaco Editor loaded');
            });
        }

        // Try to restore last opened folder from localStorage
        async function tryRestoreLastFolder() {
            const lastFolderPath = localStorage.getItem('sftp_last_folder');
            if (lastFolderPath && 'showDirectoryPicker' in window) {
                // Auto-request folder access on load
                const autoLoad = localStorage.getItem('sftp_auto_load');
                if (autoLoad === 'true') {
                    // Silently try to restore (won't work without user gesture, but worth trying)
                    console.log('Last folder:', lastFolderPath);
                }
            }
        }

        // Setup local drop zone for drag & drop
        function setupLocalDropZone() {
            const dropZone = document.getElementById('local-drop-zone');
            const localPanel = document.getElementById('local-panel');

            // Handle drag over entire panel
            localPanel.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('active');
            });

            localPanel.addEventListener('dragleave', (e) => {
                if (e.target === localPanel) {
                    dropZone.classList.remove('active');
                }
            });

            localPanel.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('active');

                const items = e.dataTransfer.items;
                if (items) {
                    await handleDroppedItems(items);
                }
            });
        }

        // Handle dropped files/folders
        async function handleDroppedItems(items) {
            localFiles = [];

            for (let i = 0; i < items.length; i++) {
                const item = items[i];

                if (item.kind === 'file') {
                    const entry = item.webkitGetAsEntry();

                    if (entry) {
                        if (entry.isFile) {
                            const file = await item.getAsFile();
                            if (file) {
                                localFiles.push({
                                    name: file.name,
                                    type: 'file',
                                    size: file.size,
                                    modified: file.lastModified,
                                    file: file
                                });
                            }
                        } else if (entry.isDirectory) {
                            await readDirectory(entry);
                        }
                    } else {
                        // Fallback for single file
                        const file = item.getAsFile();
                        if (file) {
                            localFiles.push({
                                name: file.name,
                                type: 'file',
                                size: file.size,
                                modified: file.lastModified,
                                file: file
                            });
                        }
                    }
                }
            }

            if (localFiles.length > 0) {
                document.getElementById('local-path').textContent = `${localFiles.length} file(s) loaded`;
                renderLocalFiles();
            }
        }

        // Read directory recursively
        async function readDirectory(dirEntry, path = '') {
            const dirReader = dirEntry.createReader();

            return new Promise((resolve) => {
                dirReader.readEntries(async (entries) => {
                    for (const entry of entries) {
                        const fullPath = path ? `${path}/${entry.name}` : entry.name;

                        if (entry.isFile) {
                            entry.file((file) => {
                                localFiles.push({
                                    name: fullPath,
                                    type: 'file',
                                    size: file.size,
                                    modified: file.lastModified,
                                    file: file
                                });
                            });
                        } else if (entry.isDirectory) {
                            await readDirectory(entry, fullPath);
                        }
                    }
                    resolve();
                });
            });
        }

        // Local file click handler
        function handleLocalClickNew(event, index) {
            // Ctrl+Click or Cmd+Click for multi-select
            if (event.ctrlKey || event.metaKey) {
                event.stopPropagation();
                toggleSelect('local', index);
                return;
            }

            // Regular click - just show info or toggle select
            toggleSelect('local', index);
        }

        // File input handlers
        document.getElementById('file-input').addEventListener('change', handleLocalFilesSelected);
        document.getElementById('folder-input').addEventListener('change', handleLocalFolderSelected);

        async function selectLocalFiles() {
            document.getElementById('file-input').click();
        }

        async function selectLocalFolder() {
            if ('showDirectoryPicker' in window) {
                try {
                    localDirectoryHandle = await window.showDirectoryPicker();
                    localStorage.setItem('sftp_last_folder', localDirectoryHandle.name);
                    localStorage.setItem('sftp_auto_load', 'true');
                    await loadLocalDirectory(localDirectoryHandle);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Error selecting folder:', err);
                    }
                }
            } else {
                // Fallback for browsers without File System Access API
                document.getElementById('folder-input').click();
            }
        }

        async function loadLocalDirectory(dirHandle, relativePath = '') {
            localFiles = [];
            document.getElementById('local-path').textContent = dirHandle.name + (relativePath || '');

            try {
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file') {
                        const file = await entry.getFile();
                        localFiles.push({
                            name: entry.name,
                            type: 'file',
                            size: file.size,
                            modified: file.lastModified,
                            handle: entry,
                            file: file
                        });
                    } else if (entry.kind === 'directory') {
                        localFiles.push({
                            name: entry.name,
                            type: 'directory',
                            handle: entry
                        });
                    }
                }
                renderLocalFiles();
            } catch (err) {
                console.error('Error loading directory:', err);
                alert('Error loading directory: ' + err.message);
            }
        }

        function handleLocalFilesSelected(event) {
            const files = Array.from(event.target.files);
            localFiles = files.map(file => ({
                name: file.name,
                type: 'file',
                size: file.size,
                modified: file.lastModified,
                file: file
            }));

            document.getElementById('local-path').textContent = `${files.length} file(s) selected`;
            renderLocalFiles();
        }

        function handleLocalFolderSelected(event) {
            const files = Array.from(event.target.files);
            localFiles = files.map(file => ({
                name: file.webkitRelativePath || file.name,
                type: 'file',
                size: file.size,
                modified: file.lastModified,
                file: file
            }));

            if (files.length > 0) {
                const folderName = files[0].webkitRelativePath.split('/')[0];
                document.getElementById('local-path').textContent = folderName;
            }
            renderLocalFiles();
        }

        function renderLocalFiles() {
            const list = document.getElementById('local-list');
            const dropZone = document.getElementById('local-drop-zone');

            if (localFiles.length === 0) {
                dropZone.style.display = 'flex';
                list.innerHTML = '';
                list.classList.remove('has-files');
                return;
            }

            // Hide drop zone, show files
            dropZone.style.display = 'none';
            list.classList.add('has-files');

            list.innerHTML = localFiles.map((file, index) => `
                <div class="file-item ${selectedLocal.has(index) ? 'selected' : ''}"
                     draggable="true"
                     onclick="handleLocalClickNew(event, ${index})"
                     ondragstart="handleDragStart(event, 'local', ${index})"
                     ondragend="handleDragEnd(event)"
                     oncontextmenu="showContextMenu(event, 'local', ${index})">
                    <div class="file-icon ${file.type}">
                        <i class="fas fa-${file.type === 'directory' ? 'folder' : 'file'}"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">
                            ${file.size ? `<span>${formatSize(file.size)}</span>` : ''}
                            ${file.modified ? `<span>${new Date(file.modified).toLocaleDateString()}</span>` : ''}
                        </div>
                    </div>
                    <div class="file-actions">
                        ${isConnected ? `<button onclick="event.stopPropagation(); uploadToSFTP(event, ${index})" title="Upload"><i class="fas fa-upload"></i></button>` : ''}
                    </div>
                </div>
            `).join('');

            setupDragAndDrop();
        }

        function renderRemoteFiles() {
            const list = document.getElementById('remote-list');

            if (!isConnected) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-plug"></i>
                        <h3>Not Connected</h3>
                        <p>Connect to an SFTP server to browse remote files</p>
                    </div>
                `;
                return;
            }

            if (remoteFiles.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <h3>Empty Directory</h3>
                        <p>This directory contains no files</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = remoteFiles.map((file, index) => {
                const ext = getFileExtension(file.name);
                const iconClass = file.is_dir ? 'folder' : ext;
                const icon = file.is_dir ? 'fas fa-folder' : getFileIcon(file.name);

                return `
                <div class="file-item ${selectedRemote.has(index) ? 'selected' : ''}"
                     onclick="handleRemoteClickNew(event, ${index})"
                     oncontextmenu="showContextMenu(event, 'remote', ${index})">
                    <div class="file-icon ${iconClass}">
                        <i class="${icon}"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">
                            ${file.size ? `<span>${formatSize(file.size)}</span>` : ''}
                            ${file.permissions ? `<span>${file.permissions}</span>` : ''}
                            ${file.modified ? `<span>${file.modified}</span>` : ''}
                        </div>
                    </div>
                    <div class="file-actions">
                        ${!file.is_dir ? `
                            <button onclick="event.stopPropagation(); viewFile(${index})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="event.stopPropagation(); editFile(${index})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); downloadFromSFTP(event, ${index})" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                        ` : ''}
                        <button onclick="event.stopPropagation(); deleteRemote(event, ${index})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            }).join('');

            setupDragAndDrop();
        }

        // Selection - New behavior: single click to open, Ctrl+click to select
        function handleRemoteClickNew(event, index) {
            const file = remoteFiles[index];

            // Ctrl+Click or Cmd+Click for multi-select
            if (event.ctrlKey || event.metaKey) {
                event.stopPropagation();
                toggleSelect('remote', index);
                return;
            }

            // Regular click - open file/folder
            if (file.is_dir) {
                navigateToRemote(file.path);
            } else {
                viewFile(index);
            }
        }

        function toggleSelect(side, index) {
            const set = side === 'local' ? selectedLocal : selectedRemote;
            if (set.has(index)) {
                set.delete(index);
            } else {
                set.add(index);
            }
            side === 'local' ? renderLocalFiles() : renderRemoteFiles();
        }

        function handleRemoteClick(index) {
            toggleSelect('remote', index);
        }

        function handleRemoteDoubleClick(index) {
            const file = remoteFiles[index];
            if (file.is_dir) {
                navigateToRemote(file.path);
            } else {
                // Double-click file to view it
                viewFile(index);
            }
        }

        // SFTP Connection
        function showConnectModal() {
            document.getElementById('connect-modal').classList.add('show');
        }

        function closeConnectModal() {
            document.getElementById('connect-modal').classList.remove('show');
        }

        async function connectToSFTP(event) {
            event.preventDefault();

            const host = document.getElementById('sftp-host').value;
            const port = document.getElementById('sftp-port').value;
            const username = document.getElementById('sftp-username').value;
            const password = document.getElementById('sftp-password').value;

            try {
                const formData = new FormData();
                formData.append('host', host);
                formData.append('port', port);
                formData.append('username', username);
                formData.append('password', password);

                const response = await fetch('/api/sftp/connect', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    isConnected = true;
                    currentRemotePath = data.home_dir || '/';
                    updateConnectionUI(true, host);
                    closeConnectModal();
                    await loadRemoteDirectory(currentRemotePath);
                } else {
                    alert('Connection failed: ' + data.detail);
                }
            } catch (error) {
                alert('Connection error: ' + error.message);
            }
        }

        async function disconnect() {
            try {
                await fetch('/api/sftp/disconnect', { method: 'POST' });
                isConnected = false;
                currentRemotePath = '/';
                remoteFiles = [];
                updateConnectionUI(false);
                renderRemoteFiles();
            } catch (error) {
                console.error('Disconnect error:', error);
            }
        }

        function updateConnectionUI(connected, host = '') {
            const status = document.getElementById('connection-status');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const remoteButtons = ['new-file-btn', 'new-folder-btn', 'refresh-btn', 'go-btn'];

            if (connected) {
                status.className = 'status-indicator connected';
                status.innerHTML = `<i class="fas fa-circle"></i><span>Connected to ${host}</span>`;
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'flex';
                document.getElementById('remote-path').disabled = false;
                remoteButtons.forEach(id => document.getElementById(id).disabled = false);
            } else {
                status.className = 'status-indicator disconnected';
                status.innerHTML = '<i class="fas fa-circle"></i><span>Disconnected</span>';
                connectBtn.style.display = 'flex';
                disconnectBtn.style.display = 'none';
                document.getElementById('remote-path').disabled = true;
                remoteButtons.forEach(id => document.getElementById(id).disabled = true);
            }
        }

        async function loadRemoteDirectory(path) {
            try {
                const response = await fetch(`/api/sftp/list?path=${encodeURIComponent(path)}`);
                const data = await response.json();

                if (response.ok) {
                    currentRemotePath = data.current_path;
                    document.getElementById('remote-path').value = currentRemotePath;
                    remoteFiles = data.items || [];
                    renderRemoteFiles();
                } else {
                    alert('Error loading directory: ' + data.detail);
                }
            } catch (error) {
                alert('Error loading directory: ' + error.message);
            }
        }

        async function navigateToRemote(path) {
            await loadRemoteDirectory(path);
        }

        function goToPath() {
            const path = document.getElementById('remote-path').value;
            loadRemoteDirectory(path);
        }

        function refreshLocal() {
            if (localDirectoryHandle) {
                loadLocalDirectory(localDirectoryHandle);
            }
        }

        function refreshRemote() {
            if (isConnected) {
                loadRemoteDirectory(currentRemotePath);
            }
        }

        // Upload/Download
        async function uploadToSFTP(event, index) {
            event.stopPropagation();
            if (!isConnected) {
                alert('Not connected to SFTP server');
                return;
            }

            const file = localFiles[index];
            if (!file.file) {
                alert('Cannot upload directories yet');
                return;
            }

            const remotePath = currentRemotePath + '/' + file.name;

            try {
                const formData = new FormData();
                formData.append('file', file.file);
                formData.append('remote_path', remotePath);

                const response = await fetch('/api/sftp/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('File uploaded successfully!');
                    await refreshRemote();
                } else {
                    const data = await response.json();
                    alert('Upload failed: ' + data.detail);
                }
            } catch (error) {
                alert('Upload error: ' + error.message);
            }
        }

        async function downloadFromSFTP(event, index) {
            event.stopPropagation();
            const file = remoteFiles[index];

            try {
                window.open(`/api/sftp/download?remote_path=${encodeURIComponent(file.path)}`, '_blank');
            } catch (error) {
                alert('Download error: ' + error.message);
            }
        }

        // SFTP Operations
        async function createRemoteFile() {
            const filename = prompt('Enter filename:');
            if (!filename) return;

            const path = currentRemotePath + '/' + filename;

            try {
                const formData = new FormData();
                formData.append('path', path);
                formData.append('content', '');

                const response = await fetch('/api/sftp/create', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    await refreshRemote();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function createRemoteFolder() {
            const foldername = prompt('Enter folder name:');
            if (!foldername) return;

            const path = currentRemotePath + '/' + foldername;

            try {
                const formData = new FormData();
                formData.append('path', currentRemotePath);
                formData.append('name', foldername);

                const response = await fetch('/api/sftp/mkdir', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    await refreshRemote();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteRemote(event, index) {
            event.stopPropagation();
            const file = remoteFiles[index];

            if (!confirm(`Delete ${file.name}?`)) return;

            try {
                const formData = new FormData();
                formData.append('path', file.path);

                const response = await fetch('/api/sftp/delete', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    await refreshRemote();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Drag & Drop
        let draggedItem = null;
        let draggedSide = null;

        function handleDragStart(event, side, index) {
            draggedItem = index;
            draggedSide = side;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'copy';
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
        }

        function setupDragAndDrop() {
            const remotePanel = document.getElementById('remote-panel');
            const localPanel = document.getElementById('local-panel');

            // Remote panel - accept local files
            remotePanel.addEventListener('dragover', (e) => {
                if (draggedSide === 'local' && isConnected) {
                    e.preventDefault();
                    document.getElementById('remote-drop').classList.add('active');
                }
            });

            remotePanel.addEventListener('dragleave', () => {
                document.getElementById('remote-drop').classList.remove('active');
            });

            remotePanel.addEventListener('drop', async (e) => {
                e.preventDefault();
                document.getElementById('remote-drop').classList.remove('active');

                if (draggedSide === 'local' && draggedItem !== null) {
                    await uploadToSFTP(e, draggedItem);
                }
            });

            // Local panel - accept remote files (download)
            localPanel.addEventListener('dragover', (e) => {
                if (draggedSide === 'remote') {
                    e.preventDefault();
                    document.getElementById('local-drop').classList.add('active');
                }
            });

            localPanel.addEventListener('dragleave', () => {
                document.getElementById('local-drop').classList.remove('active');
            });

            localPanel.addEventListener('drop', async (e) => {
                e.preventDefault();
                document.getElementById('local-drop').classList.remove('active');

                if (draggedSide === 'remote' && draggedItem !== null) {
                    await downloadFromSFTP(e, draggedItem);
                }
            });
        }

        // Context Menu
        function showContextMenu(event, side, index) {
            event.preventDefault();
            event.stopPropagation();

            contextMenuTarget = index;
            contextMenuSide = side;

            const menu = document.getElementById('context-menu');
            const file = side === 'local' ? localFiles[index] : remoteFiles[index];

            let html = '';

            if (side === 'remote') {
                // View and Edit options for files
                if (!file.is_dir) {
                    html += `<div class="context-menu-item" onclick="viewFile(${index})"><i class="fas fa-eye"></i><span>View</span></div>`;
                    html += `<div class="context-menu-item" onclick="editFile(${index})"><i class="fas fa-edit"></i><span>Edit</span></div>`;
                    html += `<div class="context-menu-divider"></div>`;
                    html += `<div class="context-menu-item" onclick="downloadFromSFTP(event, ${index})"><i class="fas fa-download"></i><span>Download</span></div>`;
                }
                html += `<div class="context-menu-item" onclick="renameRemote(${index})"><i class="fas fa-i-cursor"></i><span>Rename</span></div>`;
                html += `<div class="context-menu-item" onclick="copyRemote(${index})"><i class="fas fa-copy"></i><span>Copy</span></div>`;
                if (!file.is_dir) {
                    html += `<div class="context-menu-item" onclick="chmodRemote(${index})"><i class="fas fa-lock"></i><span>Permissions</span></div>`;
                }
                html += `<div class="context-menu-divider"></div>`;
                html += `<div class="context-menu-item danger" onclick="deleteRemote(event, ${index})"><i class="fas fa-trash"></i><span>Delete</span></div>`;
            } else {
                if (isConnected) {
                    html += `<div class="context-menu-item" onclick="uploadToSFTP(event, ${index})"><i class="fas fa-upload"></i><span>Upload to SFTP</span></div>`;
                }
            }

            menu.innerHTML = html;
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('show');
        }

        document.addEventListener('click', () => {
            document.getElementById('context-menu').classList.remove('show');
        });

        async function renameRemote(index) {
            const file = remoteFiles[index];
            const newName = prompt('Enter new name:', file.name);
            if (!newName || newName === file.name) return;

            const newPath = currentRemotePath + '/' + newName;

            try {
                const formData = new FormData();
                formData.append('old_path', file.path);
                formData.append('new_path', newPath);

                const response = await fetch('/api/sftp/rename', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    await refreshRemote();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function copyRemote(index) {
            const file = remoteFiles[index];
            const newName = prompt('Copy to:', file.name + '_copy');
            if (!newName) return;

            const destPath = currentRemotePath + '/' + newName;

            try {
                const formData = new FormData();
                formData.append('source_path', file.path);
                formData.append('dest_path', destPath);

                const response = await fetch('/api/sftp/copy', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    await refreshRemote();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function chmodRemote(index) {
            const file = remoteFiles[index];
            const mode = prompt('Enter permissions (e.g., 755, 644):', '644');
            if (!mode) return;

            try {
                const formData = new FormData();
                formData.append('path', file.path);
                formData.append('mode', mode);

                const response = await fetch('/api/sftp/chmod', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    await refreshRemote();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ==== FILE VIEWER/EDITOR ====

        function getFileExtension(filename) {
            const parts = filename.split('.');
            return parts.length > 1 ? parts.pop().toLowerCase() : '';
        }

        function getFileIcon(filename) {
            const ext = getFileExtension(filename);
            const iconMap = {
                // Programming
                'js': 'fab fa-js-square',
                'jsx': 'fab fa-react',
                'ts': 'fab fa-js-square',
                'tsx': 'fab fa-react',
                'py': 'fab fa-python',
                'rb': 'fas fa-gem',
                'php': 'fab fa-php',
                'java': 'fab fa-java',
                'c': 'fas fa-file-code',
                'cpp': 'fas fa-file-code',
                'go': 'fas fa-file-code',
                'rs': 'fas fa-file-code',
                'swift': 'fab fa-swift',

                // Web
                'html': 'fab fa-html5',
                'css': 'fab fa-css3-alt',
                'scss': 'fab fa-sass',
                'sass': 'fab fa-sass',
                'less': 'fab fa-less',
                'vue': 'fab fa-vuejs',

                // Config/Data
                'json': 'fas fa-brackets-curly',
                'xml': 'fas fa-file-code',
                'yml': 'fas fa-file-code',
                'yaml': 'fas fa-file-code',
                'toml': 'fas fa-file-code',
                'ini': 'fas fa-file-code',
                'env': 'fas fa-file-code',

                // Database
                'sql': 'fas fa-database',

                // Docs
                'md': 'fab fa-markdown',
                'txt': 'fas fa-file-alt',
                'pdf': 'fas fa-file-pdf',
                'doc': 'fas fa-file-word',
                'docx': 'fas fa-file-word',

                // Shell
                'sh': 'fas fa-terminal',
                'bash': 'fas fa-terminal',
                'zsh': 'fas fa-terminal',

                // Other
                'git': 'fab fa-git-alt',
                'gitignore': 'fab fa-git-alt',
                'log': 'fas fa-file-alt'
            };

            return iconMap[ext] || 'fas fa-file';
        }

        function getLanguageForFile(filename) {
            const ext = getFileExtension(filename);
            const languageMap = {
                'js': 'javascript',
                'jsx': 'javascript',
                'ts': 'typescript',
                'tsx': 'typescript',
                'py': 'python',
                'rb': 'ruby',
                'php': 'php',
                'java': 'java',
                'c': 'c',
                'cpp': 'cpp',
                'go': 'go',
                'rs': 'rust',
                'swift': 'swift',
                'html': 'html',
                'css': 'css',
                'scss': 'scss',
                'sass': 'sass',
                'less': 'less',
                'vue': 'html',
                'json': 'json',
                'xml': 'xml',
                'yml': 'yaml',
                'yaml': 'yaml',
                'toml': 'ini',
                'ini': 'ini',
                'sql': 'sql',
                'md': 'markdown',
                'sh': 'shell',
                'bash': 'shell',
                'log': 'plaintext'
            };

            return languageMap[ext] || 'plaintext';
        }

        async function viewFile(index) {
            await editFile(index, true); // View mode is same as edit but read-only
        }

        async function editFile(index, readOnly = false) {
            const file = remoteFiles[index];
            if (file.is_dir) return;

            try {
                // Fetch file content
                const response = await fetch(`/api/sftp/read?path=${encodeURIComponent(file.path)}`);
                if (!response.ok) {
                    throw new Error('Failed to read file');
                }

                const data = await response.json();
                const content = data.content || '';

                currentEditingFile = file;
                editorOriginalContent = content;

                // Show editor modal
                const modal = document.getElementById('editor-modal');
                modal.classList.add('show');

                // Update header info
                document.getElementById('editor-filename').textContent = file.name;
                document.getElementById('editor-language').textContent = getLanguageForFile(file.name);
                document.getElementById('editor-size').textContent = formatSize(file.size || content.length);
                document.getElementById('editor-modified').style.display = 'none';

                // Save button visibility
                document.getElementById('save-btn').style.display = readOnly ? 'none' : 'flex';

                // Create or update Monaco Editor
                require(['vs/editor/editor.main'], function () {
                    const container = document.getElementById('editor-container');
                    container.innerHTML = ''; // Clear previous editor

                    monacoEditor = monaco.editor.create(container, {
                        value: content,
                        language: getLanguageForFile(file.name),
                        theme: 'vs-dark',
                        automaticLayout: true,
                        fontSize: 14,
                        minimap: { enabled: true },
                        scrollBeyondLastLine: false,
                        readOnly: readOnly,
                        lineNumbers: 'on',
                        renderLineHighlight: 'all',
                        folding: true,
                        wordWrap: 'off',
                        bracketPairColorization: {
                            enabled: true
                        }
                    });

                    // Update stats
                    updateEditorStats();

                    // Listen for content changes
                    monacoEditor.onDidChangeModelContent(() => {
                        updateEditorStats();
                        const currentContent = monacoEditor.getValue();
                        const isModified = currentContent !== editorOriginalContent;
                        document.getElementById('editor-modified').style.display = isModified ? 'flex' : 'none';
                    });

                    // Listen for cursor position changes
                    monacoEditor.onDidChangeCursorPosition(() => {
                        updateEditorStats();
                    });
                });

            } catch (error) {
                alert('Error loading file: ' + error.message);
            }
        }

        function updateEditorStats() {
            if (!monacoEditor) return;

            const model = monacoEditor.getModel();
            const position = monacoEditor.getPosition();

            const lines = model.getLineCount();
            const chars = model.getValue().length;
            const ln = position.lineNumber;
            const col = position.column;

            document.getElementById('editor-lines').textContent = lines;
            document.getElementById('editor-chars').textContent = chars;
            document.getElementById('editor-ln').textContent = ln;
            document.getElementById('editor-col').textContent = col;
        }

        async function saveFile() {
            if (!monacoEditor || !currentEditingFile) return;

            const content = monacoEditor.getValue();

            try {
                const formData = new FormData();
                formData.append('path', currentEditingFile.path);
                formData.append('content', content);

                const response = await fetch('/api/sftp/write', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    editorOriginalContent = content;
                    document.getElementById('editor-modified').style.display = 'none';
                    alert('‚úÖ File saved successfully!');
                    await refreshRemote();
                } else {
                    const data = await response.json();
                    alert('Error saving file: ' + data.detail);
                }
            } catch (error) {
                alert('Error saving file: ' + error.message);
            }
        }

        function closeEditor() {
            if (monacoEditor) {
                const currentContent = monacoEditor.getValue();
                const isModified = currentContent !== editorOriginalContent;

                if (isModified) {
                    if (!confirm('You have unsaved changes. Close anyway?')) {
                        return;
                    }
                }

                monacoEditor.dispose();
                monacoEditor = null;
            }

            currentEditingFile = null;
            editorOriginalContent = '';

            document.getElementById('editor-modal').classList.remove('show');
        }

        // Utility
        function formatSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>
